
@{
    ViewBag.Title = "Index";
}

<h2>Index</h2>

<p>
    @Html.ActionLink("Create New", "Create")
</p>
<table class="table" id="transactionTable">
    <tr>
        <th>
            @Html.ActionLink("Navn", "Index", new { sortOrder = ViewBag.NameSortParm, @class = "sort" })
        </th>
        <th>
            @Html.ActionLink("Værdi", "Index", new { sortOrder = ViewBag.ValueSortParm, @class = "sort" })
        </th>
        <th>
            @Html.ActionLink("Dato", "Index", new { sortOrder = ViewBag.DateSortParm, @class = "sort" })
        </th>
        <th>
            @Html.ActionLink("Kategori", "Index", new { sortOrder = ViewBag.CatSortParm, @class = "sort" })
        </th>
    </tr>

    @*@foreach (var item in Model)
    {
        <tr>
            <td>
                @Html.ActionLink(item.Text, "Details", new { id = item.Id })
            </td>
            <td>
                @item.Value.ToString() DKK
            </td>
            <td>
                @item.Date.Value.ToString("dd-MM-yyyy")
            </td>
            <td>
                @Html.ActionLink(item.Category.Name, "Edit", "Categories", new { id = item.Category.Id }, null)
            </td>
        </tr>
    }*@

</table>

@section scripts{
    <script>
        function replaceAll(str, identifier, value)
        {
            while (str.indexOf(identifier) != -1) 
            {
                str = str.replace(identifier, value);
            }

            return str;
        }
        function renderTemplate(template, data)
        {
            console.log(data);
            console.log("data: " + JSON.stringify(data));
            Object.keys(data).forEach(function (k) {
                var identifier = '{{' + k + '}}';
                template = replaceAll(template, identifier, data[k]);
            });
            return template;
        }

        let template = [
            '<tr>',
                '<td>',
                    '<a href="/Transactions/Details/{{id}}">{{title}}</a>',
                '</td>',
                '<td>',
                    '{{value}}',
                '</td>',
                    '{{date}}',
                '<td>',
                    '<a href="Categories/Edit/{{fk_categoryid}}">{{fk_categoryname}}</a>',
                '</td>',
            '</tr>'
        ].join('\n');
        let socket = io('localhost:3000');

        socket.on('GetAllTransactions', function (res) {
            console.log("res: " + JSON.stringify(res, null, 4));
            if (res.status === 200)
            {
                console.log("status 200");
                console.log("res length: " + res.length);
                for (let i = 0; i < res.result.length; i++)
                {
                    console.log("forloop");
                    let elm = renderTemplate(template, res.result[i]);
                    $('#transactionTable').append(elm);
                }
            }
        });

        socket.emit('GetAllTransactions', '');
    </script>
}
